project_id = "sxorybjlxyquxteptdyk"

[auth.password]
hibp_enabled = true
min_length = 8
required_characters = ["upper", "lower", "number", "symbol"]

[functions.recalculate-animal]
verify_jwt = true

[functions.log-auth-event]
verify_jwt = false

[functions.realtime-token]
verify_jwt = true

[functions.report-test-results]
verify_jwt = false

[functions.admin-create-user]
verify_jwt = true

[functions.backfill-stats]
verify_jwt = true

[functions.calculate-daily-stats]
verify_jwt = true

[functions.populate-weights]
verify_jwt = true

[functions.process-voice-training]
verify_jwt = true

[functions.voice-to-text]
verify_jwt = true

[functions.text-to-speech]
verify_jwt = true

[functions.process-farmhand-activity]
verify_jwt = true

[functions.submit-correction]
verify_jwt = true

[functions.mapbox-token]
verify_jwt = false

[functions.bulk-recalculate-carabao-stages]
verify_jwt = true

[functions.process-farmer-feedback]
verify_jwt = true

[functions.doc-aga]
verify_jwt = true

[functions.send-team-invitation]
verify_jwt = true

[functions.merchant-signup]
verify_jwt = false

[functions.admin-permanent-delete-farm]
verify_jwt = true

-- Phase 2: Database Functions

-- 2.1 Function: requires_approval()
CREATE OR REPLACE FUNCTION public.requires_approval(
  _farm_id UUID,
  _user_id UUID,
  _activity_type TEXT
) RETURNS BOOLEAN
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public
AS $$
DECLARE
  _is_farmhand BOOLEAN;
  _settings RECORD;
BEGIN
  -- Only farmhands need approval (owners/managers skip)
  _is_farmhand := is_farmhand(_user_id, _farm_id);
  
  IF NOT _is_farmhand THEN
    RETURN false;
  END IF;
  
  -- Check farm-specific settings
  SELECT * INTO _settings
  FROM farm_approval_settings
  WHERE farm_id = _farm_id;
  
  -- No settings = use defaults (require approval)
  IF NOT FOUND THEN
    RETURN true;
  END IF;
  
  -- Check if this activity type requires approval
  IF _settings.require_approval_for_types IS NOT NULL THEN
    RETURN _activity_type = ANY(_settings.require_approval_for_types);
  END IF;
  
  -- Default: require approval for all types
  RETURN true;
END;
$$;

[functions.process-auto-approvals]
verify_jwt = false

[functions.review-pending-activity]
verify_jwt = true